<div class="ventas-container p-6 bg-[#FAFAFA] min-h-screen">

  <section class="buscador-card">
    <div class="buscador-grid">

      <div class="filtro filtro-buscador">
        <label class="filtro-label">Buscar</label>
        <div class="buscador-input-wrapper">
          <span class="material-symbols-rounded search-icon">search</span>
          <input
            type="text"
            [(ngModel)]="busqueda"
            placeholder="Buscar producto..."
            class="buscador-input"
          />
        </div>
      </div>

      <div class="filtro">
        <label class="filtro-label">Categor√≠a</label>
        <select
          [(ngModel)]="categoriaSeleccionada"
          class="filtro-select"
        >
          <option>Todas las categor√≠as</option>
          <option *ngFor="let cat of categorias" [value]="cat.nombreCategoria">{{ cat.nombreCategoria }}</option>
        </select>
      </div>
      <!-- üìã Botones alineados a la derecha -->
      <div class="botones-acciones">
        <button class="btn-filtrar" (click)="aplicarFiltros(busqueda, categoriaSeleccionada)">Filtrar</button>
        <button (click)="irARegistros()" class="btn-registros">Ver registros</button>
      </div>

    </div>
  </section>

  <!-- üü© Cuadro 2 + 3: Productos m√°s vendidos y resultados de b√∫squeda -->
  <section class="grid grid-cols-[30%_70%] gap-6 mb-6">

    <!-- üü¶ Cuadro 2: Productos m√°s vendidos -->
    <div class="productos-card bg-white rounded-2xl p-4 shadow">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-lg">M√°s vendidos</h3>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div *ngFor="let prod of productosMasVendidos"
              class="bg-[#F9F9F9] rounded-lg p-3 flex flex-col justify-between hover:shadow transition">
          <div>
            <div class="font-medium text-gray-800 text-sm">{{ prod.nombreProducto }}</div>
          </div>

          <div class="mt-3 flex items-center justify-between">
            <!-- wrapper en TS: seleccionarProducto(prod) -->
            <button (click)="anadirProducto(prod)"
                    class="px-2 py-1 rounded-md border text-xs font-medium hover:bg-gray-200 transition"
                    title="Agregar {{ prod.nombreProducto }}">
              Agregar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- üüß Cuadro 3: Resultados de b√∫squeda -->
    <div class="resultados-card bg-white rounded-2xl p-4 shadow flex flex-col">
      <h3 class="font-semibold text-lg mb-3">Resultados de b√∫squeda</h3>

      <div class="overflow-y-auto flex-1 max-h-[100px]">
        <table class="w-full text-sm border-collapse">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="text-left p-2">Producto</th>
              <th class="text-left p-2">Precio</th>
              <th class="text-left p-2">Stock</th>
              <th class="text-center p-2">Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let prod of resultadosFiltrados" class="border-b hover:bg-gray-50">
              <td class="p-2">{{ prod.nombreProducto }}</td>
              <td class="p-2">S/{{ prod.precioProducto | number:'1.2-2' }}</td>
              <td class="p-2">{{ prod.cantidadProducto }}</td>
              <td class="p-2 text-center">
                <!-- wrapper en TS: seleccionarProducto(prod) -->
                <button (click)="anadirProducto(prod)"
                        class="bg-[#DCCE40] text-black px-3 py-1 rounded-md text-xs font-semibold hover:opacity-90">
                  Agregar
                </button>
              </td>
            </tr>
            <tr *ngIf="resultadosFiltrados.length === 0">
              <td colspan="4" class="text-center text-gray-500 py-4">Sin resultados</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- üü® Cuadro 4: Carrito -->
  <section class="carrito-card bg-white rounded-2xl p-4 shadow">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-semibold text-lg">Productos seleccionados</h3>
      <span class="text-sm text-gray-500">({{ itemsCarrito.length }})</span>
    </div>

    <div class="overflow-y-auto max-h-[45vh]">
      <table class="w-full text-sm border-collapse">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="p-2 text-left">Producto</th>
            <th class="p-2 text-center">Cantidad</th>
            <th class="p-2 text-center">Precio</th>
            <th class="p-2 text-center">Total</th>
            <th class="p-2 text-center">Eliminar</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let item of itemsCarrito" class="border-b hover:bg-gray-50">
            <td class="p-2">{{ item.producto.nombreProducto }}</td>
            <td class="p-2 text-center">
              <div class="inline-flex items-center border rounded-md">
                <!-- wrappers en TS para no llamar el service privado -->
                <button (click)="decrementarCantidad(item.producto)" class="px-2 py-1">‚àí</button>
                <span class="px-3">{{item.cantidad}}</span>
                <button (click)="incrementarCantidad(item.producto)" class="px-2 py-1">+</button>
              </div>
            </td>
            <td class="p-2 text-center">S/{{ item.producto.precioProducto}}</td>
            <td class="p-2 text-center font-semibold">S/{{ (item.producto.precioProducto! * item.cantidad)}}</td>
            <td class="p-2 text-center">
              <button (click)="eliminarProducto(item.producto)"
                      class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">
                Eliminar del carrito
              </button>
            </td>
          </tr>

          <tr *ngIf="itemsCarrito.length === 0">
            <td colspan="5" class="text-center text-gray-500 py-4">Carrito vac√≠o</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="flex justify-between items-center font-semibold text-base mt-4">
      <span>Total:</span>
      <span>S/{{ total }}</span>
    </div>

    <button (click)="abrirModal()"
            class="mt-4 w-full bg-[#2C2C2D] text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
      Continuar venta
    </button>
  </section>
</div>
<div *ngIf="mostrarModal" class="fixed inset-0 backdrop-blur-md flex justify-center items-center z-50">
  <div class="bg-white rounded-2xl shadow-lg w-[500px] p-6 relative">

    <!-- Bot√≥n de cerrar -->
    <button (click)="cerrarModal()"
            class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
      ‚úï
    </button>

    <!-- Paso 1: Selecci√≥n de tipo de comprobante -->
    <div *ngIf="paso === 1">
      <h2 class="text-xl font-semibold mb-4 text-center">Seleccionar tipo de comprobante</h2>

      <div class="flex flex-col gap-3">
        <label class="flex items-center gap-2">
          <input type="radio" name="tipo" value="Boleta simple" [(ngModel)]="tipoComprobante" />
          Boleta simple
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="tipo" value="Boleta con cliente" [(ngModel)]="tipoComprobante" />
          Boleta con cliente
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="tipo" value="Factura" [(ngModel)]="tipoComprobante" />
          Factura
        </label>
      </div>

      <button (click)="irPaso2()"
              class="mt-6 w-full bg-[#2C2C2D] text-white py-2 rounded-lg font-semibold hover:opacity-90 transition">
        Siguiente
      </button>
    </div>

    <!-- Paso 2: Datos del cliente o m√©todo de pago -->
    <div *ngIf="paso === 2">
      <h2 class="text-xl font-semibold mb-4 text-center">Datos del cliente y m√©todo de pago</h2>

      <!-- üîπ Boleta simple -->
      <div *ngIf="tipoComprobante === 'Boleta simple'">
        <label class="block mb-2 font-medium">Cliente</label>
        <input type="text" [(ngModel)]="nombreCliente" value="Clientes varios" readonly class="w-full border rounded-md p-2 bg-gray-100 mb-4" />

        <label class="block mb-2 font-medium">M√©todo de pago</label>
        <select [(ngModel)]="metodoPago" class="w-full border rounded-md p-2">
          <option value="efectivo">Efectivo</option>
          <option value="tarjeta">Tarjeta</option>
          <option value="yape">Yape</option>
        </select>
      </div>

      <!-- üîπ Boleta con cliente -->
      <div *ngIf="tipoComprobante === 'Boleta con cliente'">
        <label class="block mb-2 font-medium">DNI</label>
        <input type="text" (input)="onDniChange()" [(ngModel)]="dniCliente" maxlength="8" class="w-full border rounded-md p-2 mb-2" />

        <button (click)="buscarClientePorDNI()" class="bg-gray-800 text-white px-4 py-2 rounded-md mb-4 hover:opacity-90">
          Buscar
        </button>

        <label class="block mb-2 font-medium">Nombre del cliente</label>
        <input type="text" [(ngModel)]="nombreCliente" readonly class="w-full border rounded-md p-2 bg-gray-100 mb-4" />

        <label class="block mb-2 font-medium">M√©todo de pago</label>
        <select [(ngModel)]="metodoPago" class="w-full border rounded-md p-2">
          <option value="efectivo">Efectivo</option>
          <option value="tarjeta">Tarjeta</option>
          <option value="yape">Yape</option>
        </select>
      </div>

      <!-- üîπ Factura -->
      <div *ngIf="tipoComprobante === 'Factura'">
        <label class="block mb-2 font-medium">RUC</label>
        <input type="text" (input)="onRucChange()" [(ngModel)]="rucCliente" maxlength="11" class="w-full border rounded-md p-2 mb-2" />

        <button (click)="buscarClientePorRUC()" class="bg-gray-800 text-white px-4 py-2 rounded-md mb-4 hover:opacity-90">
          Buscar
        </button>

        <label class="block mb-2 font-medium">Raz√≥n social</label>
        <input type="text" [(ngModel)]="razonSocial" readonly class="w-full border rounded-md p-2 bg-gray-100 mb-4" />

        <label class="block mb-2 font-medium">M√©todo de pago</label>
        <select [(ngModel)]="metodoPago" class="w-full border rounded-md p-2">
          <option value="efectivo">Efectivo</option>
          <option value="tarjeta">Tarjeta</option>
          <option value="transferencia">Transferencia</option>
        </select>
      </div>

      <div class="flex justify-between mt-6">
        <button (click)="volverPaso1()" class="px-4 py-2 border rounded-md hover:bg-gray-100">Atr√°s</button>
        <button (click)="validarPaso2()" class="px-4 py-2 bg-[#2C2C2D] text-white rounded-md hover:opacity-90">Siguiente</button>
      </div>
    </div>

    <!-- Paso 3: Confirmaci√≥n -->
    <div *ngIf="paso === 3">
      <h2 class="text-xl font-semibold mb-4 text-center">Resumen de la venta</h2>

      <div class="space-y-2 text-sm mb-4">
        <p><strong>Tipo:</strong> {{ tipoComprobante | titlecase }}</p>
        <p *ngIf="dniCliente"><strong>DNI:</strong> {{ dniCliente }}</p>
        <p *ngIf="rucCliente"><strong>RUC:</strong> {{ rucCliente }}</p>
        <p *ngIf="nombreCliente"><strong>Cliente:</strong> {{ nombreCliente }}</p>
        <p *ngIf="razonSocial"><strong>Raz√≥n social:</strong> {{ razonSocial }}</p>
        <p><strong>M√©todo de pago:</strong> {{ metodoPago | titlecase }}</p>
        <p><strong>Total:</strong> S/{{ total | number:'1.2-2' }}</p>
      </div>

      <div class="flex justify-between">
        <button (click)="paso = 2" class="px-4 py-2 border rounded-md hover:bg-gray-100">Atr√°s</button>
        <button (click)="confirmarVenta()" class="px-4 py-2 bg-[#2C2C2D] text-white rounded-md hover:opacity-90">
          Confirmar venta
        </button>
      </div>
    </div>

  </div>
</div>



