<div class="stock-container">
  <!-- üß© Filtros -->
  <div class="filtros-card">
    <div class="filtros-grid centrado">
      <div class="filtro-item">
        <label for="s-buscar">Buscar producto</label>
        <input id="s-buscar" [(ngModel)]="busqueda" type="text" placeholder="Martillo, taladro, tornillos‚Ä¶">
      </div>

      <div class="filtro-item">
        <label for="s-categoria">Categor√≠a</label>
        <select [(ngModel)]="categoriaSeleccionada" id="s-categoria">
          <option>Todas las categor√≠as</option>
          <option *ngFor="let cat of categorias" value="{{cat.nombreCategoria}}">{{cat.nombreCategoria}}</option>
        </select>
      </div>

      <div class="filtro-item">
        <label for="s-estado">Estado</label>
        <select id="s-estado" [(ngModel)]="estado">
          <option value="Todos">Todos</option>
          <option value="stock bajo">Stock bajo</option>
          <option value="sin stock">Sin stock</option>
          <option value="activo">Activo</option>
          <option value="inactivo">Inactivo</option>
        </select>
      </div>

      <div class="filtro-item">
        <label for="s-orden">Ordenar por</label>
        <select id="s-orden" [(ngModel)]="orden">
          <option value="id">C√≥digo</option>
          <option value="nombre">Nombre</option>
          <option value="stock">Stock</option>
          <option value="precio">Precio</option>
        </select>
      </div>

      <div class="filtro-botones">
        <button class="btn-filtrar" type="button" (click)="filtrarProductos()">Filtrar</button>
        <button class="btn-limpiar" type="button" (click)="limpiarFiltros()">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- üí∞ Resumen -->
  <section class="resumen-grid">
    <div class="resumen-card">
      <h3>Productos</h3>
      <p class="monto">{{productosFiltrados.length}}</p>
    </div>
    <div class="resumen-card">
      <h3>Unidades en almac√©n</h3>
      <p class="monto">{{unidadesEnAlmacen}}</p>
    </div>
    <div class="resumen-card">
      <h3>Alertas</h3>
      <p class="badges">
        <span class="estado bajo">Bajo: {{totalUnidadesStockBajo}}</span>
        <span class="estado sin">Sin stock: {{totalUnidadesStockSin}}</span>
      </p>
    </div>
  </section>

  <!-- üìã Inventario -->
  <div class="tabla-card">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold">Inventario</h2>
      <button
        (click)="obtenerPrediccionesIA()"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition">
        üìä Ver recomendaciones IA
      </button>
    </div>

    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Producto</th>
          <th>Categor√≠a</th>
          <th class="num">Stock</th>
          <th class="num">M√≠n.</th>
          <th class="num">Precio</th>
          <th style="text-align: center;">Estado</th>
          <th class="acciones">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let prod of productosFiltrados">
          <td>{{prod.idProducto}}</td>
          <td>{{prod.nombreProducto}}</td>
          <td>{{prod.categoria!.nombreCategoria}}</td>
          <td class="num">{{prod.cantidadProducto}}</td>
          <td class="num">10</td>
          <td class="num"> S/.{{prod.precioProducto}}</td>
          <td *ngIf="prod.cantidadProducto! > 10" style="text-align: center;">
            <span class="estado ok">Activo</span>
          </td>
          <td *ngIf="prod.cantidadProducto! < 10 && prod.cantidadProducto! > 0" style="text-align: center;">
            <span class="estado bajo">Bajo</span>
          </td>
          <td *ngIf="prod.cantidadProducto! == 0" style="text-align: center;">
            <span class="estado sin">Sin stock</span>
          </td>
          <td class="acciones">
            <button
              type="button"
              (click)="abrirModal(prod, 'ver')"
              class="bg-gray-100 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-200 transition font-medium">
              Ver
            </button>

            <button
              type="button"
              (click)="abrirModal(prod, 'editar')"
              class="bg-black text-white px-3 py-1 rounded-md hover:bg-gray-800 transition font-medium">
              Editar
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- üì¶ Modal Ver/Editar Producto -->
<div
  *ngIf="mostrarModal"
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50"
  (click)="cerrarModal()"
>
  <div 
    class="bg-white rounded-2xl shadow-lg w-full max-w-md p-6 relative animate-fade-in" 
    (click)="$event.stopPropagation()"
  >
    <h2 class="text-xl font-semibold text-center mb-4">
      {{ modoEdicion ? 'Editar Producto' : 'Detalle del Producto' }}
    </h2>

    <div class="flex flex-col gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">Nombre del producto</label>
        <input type="text" [value]="productoSeleccionado?.nombreProducto" 
               class="w-full border border-gray-300 rounded-lg p-2 bg-gray-100" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">Descripci√≥n</label>
        <textarea [value]="productoSeleccionado?.descripcionProducto" 
                  class="w-full border border-gray-300 rounded-lg p-2 bg-gray-100 resize-none" rows="3" readonly></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">Precio</label>
        <input type="text" [value]="'S/. ' + productoSeleccionado?.precioProducto" 
               class="w-full border border-gray-300 rounded-lg p-2 bg-gray-100" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">Stock disponible</label>
        <input 
          type="number" 
          [(ngModel)]="stockNuevo" 
          [readonly]="!modoEdicion"
          class="w-full border border-gray-300 rounded-lg p-2" 
          [ngClass]="{
            'bg-gray-100': !modoEdicion,
            'bg-white': modoEdicion
          }"
        >
      </div>

      <div *ngIf="compararStock()">
        <label class="block text-sm font-medium text-gray-600 mb-1">Raz√≥n de cambio de stock</label>
        <input 
          type="text" 
          [(ngModel)]="razonDeCambio" 
          class="w-full border border-gray-300 rounded-lg p-2" 
          [ngClass]="{
            'bg-gray-100': !modoEdicion,
            'bg-white': modoEdicion
          }"
        >
      </div>
    </div>

    <div class="mt-6 flex justify-center gap-3">
      <button 
        *ngIf="!modoEdicion"
        type="button" 
        (click)="cerrarModal()"
        class="bg-gray-800 text-white px-5 py-2 rounded-lg hover:bg-gray-900 transition">
        Cerrar
      </button>

      <ng-container *ngIf="modoEdicion">
        <button 
          type="button" 
          (click)="guardarCambios()"
          class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition">
          Guardar
        </button>
        <button 
          type="button" 
          (click)="cerrarModal()"
          class="bg-gray-500 text-white px-5 py-2 rounded-lg hover:bg-gray-600 transition">
          Cancelar
        </button>
      </ng-container>
    </div>
  </div>
</div>

<!-- ü§ñ Modal Recomendaciones IA -->
<div 
  *ngIf="mostrarModalIA"
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50"
  (click)="cerrarModalIA()"
>
  <div 
    class="bg-white rounded-2xl shadow-lg w-full max-w-3xl p-6 relative animate-fade-in" 
    (click)="$event.stopPropagation()"
  >
    <h2 class="text-2xl font-semibold text-center mb-4">ü§ñ Recomendaciones de Compra (IA)</h2>

    <div *ngIf="loadingIA" class="text-center py-6 text-gray-600">Cargando predicciones...</div>

    <div *ngIf="!loadingIA && prediccionesIA.length > 0">
      <table class="w-full border border-gray-200 rounded-lg text-sm">
        <thead>
          <tr class="bg-gray-100">
            <th class="py-2 px-3 text-left">Producto</th>
            <th class="py-2 px-3 text-right">Stock actual</th>
            <th class="py-2 px-3 text-right">Promedio ventas</th>
            <th class="py-2 px-3 text-right">Recomendado comprar</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of prediccionesIA" class="border-t hover:bg-gray-50">
            <td class="py-2 px-3">{{item.nombreProducto}}</td>
            <td class="py-2 px-3 text-right">{{item.stock_actual}}</td>
            <td class="py-2 px-3 text-right">{{item.promedio_ventas | number:'1.0-0'}}</td>
            <td class="py-2 px-3 text-right font-semibold text-blue-600">{{item.recomendado_comprar}}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="!loadingIA && prediccionesIA.length === 0" class="text-center py-4 text-gray-500">
      No se encontraron recomendaciones.
    </div>

    <div class="mt-6 text-center">
      <button 
        type="button" 
        (click)="cerrarModalIA()"
        class="bg-gray-800 text-white px-6 py-2 rounded-lg hover:bg-gray-900 transition">
        Cerrar
      </button>
    </div>
  </div>
</div>
